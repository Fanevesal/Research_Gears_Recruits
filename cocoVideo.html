<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Video Object Detection (coco-ssd)</title>
    <!-- TF.js + coco-ssd -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
  </head>
  <style>
    video,canvas{
        width: 500px;
    }
  </style>
  <body>
    <h1>Pick a video, then watch detection</h1>
    <input id="file" type="file" accept="video/*" />
    <div>
      <video id="vid" playsinline muted controls></video>
      <canvas id="canvas"></canvas>
    </div>

    <script>
      const fileInput = document.getElementById('file');
      const video = document.getElementById('vid');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      let model = null;
      let running = false;

      // Load model ASAP
      // cocoSsd.load().then(m => { model = m; console.log('coco-ssd ready'); });

      fileInput.addEventListener('change', async () => {
        if (!fileInput.files[0]) return;
        // Load the chosen video
        const url = URL.createObjectURL(fileInput.files[0]);
        video.src = url;
        await video.play(); // start playback
        fitCanvas();
        if (!running) {
          running = true;
          loop();
        }
      });

      // Keep canvas matched to video size
      function fitCanvas() {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 360;
      }
      video.addEventListener('loadedmetadata', fitCanvas);
      window.addEventListener('resize', fitCanvas);

      async function loop() {
        if (!running) return;
        if (model && video.readyState >= 2 && !video.paused && !video.ended) {
          // Draw current frame to canvas
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          // Run detection
          const preds = await model.detect(canvas); // accepts image/canvas/video
          // Draw boxes
          drawPreds(preds);
        }
        requestAnimationFrame(loop);
      }

      function drawPreds(preds) {
        ctx.lineWidth = 2;
        ctx.font = '16px monospace';
        preds.forEach(p => {
          const [x, y, w, h] = p.bbox;
          ctx.strokeStyle = 'red';
          ctx.fillStyle = 'red';
          ctx.strokeRect(x, y, w, h);
          const label = `${p.class} (${(p.score*100).toFixed(1)}%)`;
          const pad = 4;
          const textW = ctx.measureText(label).width;
          const textH = 16 + pad*2;
          ctx.fillRect(x, y - textH, textW + pad*2, textH);
          ctx.fillStyle = 'white';
          ctx.fillText(label, x + pad, y - pad);
        });
      }
    </script>
  </body>
</html>